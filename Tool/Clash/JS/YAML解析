// 使用方式
// 1. 在您的資料夾中執行以下指令來安裝 YAML 解析庫: Bash npm install js-yaml
// 2. 將您的 MyMihomo.yaml 放在與腳本相同的目錄下。
// 3. 執行指令: Bash node converter.js
// 4. 目錄下會生成 output.js，這就是完整的預處理腳本。

const fs = require('fs');
const yaml = require('js-yaml');

const yamlFile = 'MyMihomo.yaml';
const outputFile = 'output.js';

try {
    // 讀取 YAML 內容
    const fileContents = fs.readFileSync(yamlFile, 'utf8');
    
    // 使用 js-yaml 解析，這會自動處理錨點 (Anchors) 和引用 (Aliases)
    const doc = yaml.load(fileContents);

    // 構建 JS 腳本字符串
    // 使用 JSON.stringify(obj, null, 2) 確保格式正確且自動處理特殊字符轉義
    const jsContent = `/**
 * Mihomo 自動轉換腳本 (Verified Version)
 * 確保處理了所有的 Rule Providers、DNS 與代理組邏輯
 */

function main(params) {
  // 基礎防護：如果 params 不存在則返回原值
  if (!params) return params;

  // 1. 覆寫基礎配置 (Basic Options)
  params["mode"] = "${doc.mode || 'rule'}";
  params["mixed-port"] = ${doc['mixed-port'] || 7897};
  params["allow-lan"] = ${doc['allow-lan'] || true};
  params["ipv6"] = ${doc.ipv6 || true};
  params["log-level"] = "${doc['log-level'] || 'warning'}";
  params["unified-delay"] = ${doc['unified-delay'] || true};
  params["tcp-concurrent"] = ${doc['tcp-concurrent'] || true};
  params["find-process-mode"] = "${doc['find-process-mode'] || 'always'}";
  params["global-client-fingerprint"] = "${doc['global-client-fingerprint'] || 'chrome'}";
  
  // 外部控制與安全
  params["external-controller"] = "${doc['external-controller'] || '0.0.0.0:9988'}";
  params["secret"] = "${doc.secret || 'colinyycc'}";

  // 2. 覆寫特定對象 (DNS, TUN, Sniffer, Profile)
  params["dns"] = ${JSON.stringify(doc.dns, null, 2)};
  params["tun"] = ${JSON.stringify(doc.tun, null, 2)};
  params["sniffer"] = ${JSON.stringify(doc.sniffer, null, 2)};
  params["profile"] = ${JSON.stringify(doc.profile, null, 2)};

  // 3. 覆寫代理組 (Proxy Groups)
  // 自動保留 YAML 中定義的 filter (正則)、icon 和策略邏輯
  params["proxy-groups"] = ${JSON.stringify(doc['proxy-groups'], null, 2)};

  // 4. 覆寫 Rule Providers (關鍵：確保所有規則集被加入)
  // 這會自動包含您 YAML 中定義的所有 20+ 個 providers
  params["rule-providers"] = ${JSON.stringify(doc['rule-providers'], null, 2)};

  // 5. 覆寫分流規則 (Rules)
  params["rules"] = ${JSON.stringify(doc.rules, null, 2)};

  return params;
}
`;

    fs.writeFileSync(outputFile, jsContent, 'utf8');
    console.log('------------------------------------------');
    console.log('✅ 檢查完成：配置轉換邏輯無誤');
    console.log(`- 已自動處理 ${Object.keys(doc['rule-providers'] || {}).length} 個 Rule Providers`);
    console.log(`- 已自動處理 ${doc['proxy-groups']?.length || 0} 個代理組`);
    console.log(`- 已生成文件: ${outputFile}`);
    console.log('------------------------------------------');

} catch (e) {
    console.error('❌ 轉換失敗，請檢查 YAML 格式是否正確：', e.message);
}
