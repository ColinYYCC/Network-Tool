// 使用方式
// 1. 在您的資料夾中執行以下指令來安裝 YAML 解析庫: Bash npm install js-yaml
// 2. 將您的 MyMihomo.yaml 放在與腳本相同的目錄下。
// 3. 執行指令: Bash node converter.js
// 4. 目錄下會生成 output.js，這就是完整的預處理腳本。

const fs = require('fs');
const yaml = require('js-yaml');

// 設定檔案名稱
const yamlFile = 'MyMihomo.yaml';
const outputFile = 'output.js';

try {
    // 讀取並解析 YAML
    const fileContents = fs.readFileSync(yamlFile, 'utf8');
    const doc = yaml.load(fileContents);

    // 構建 JS 內容
    const jsContent = `/**
 * 自動生成的 Mihomo JS 預處理腳本
 * 源文件: ${yamlFile}
 */

function main(params) {
    if (!params.proxies && !params["proxy-providers"]) return params;

    overwriteBasicOptions(params);
    overwriteDns(params);
    overwriteTunnel(params);
    overwriteProxyGroups(params);
    overwriteRuleProviders(params);
    overwriteRules(params);

    return params;
}

// 基礎配置轉換
function overwriteBasicOptions(params) {
    const config = {
        "mode": "${doc.mode || 'rule'}",
        "mixed-port": ${doc['mixed-port'] || 7897},
        "allow-lan": ${doc['allow-lan'] || true},
        "ipv6": ${doc.ipv6 || true},
        "log-level": "${doc['log-level'] || 'warning'}",
        "unified-delay": ${doc['unified-delay'] || true},
        "tcp-concurrent": ${doc['tcp-concurrent'] || true},
        "find-process-mode": "${doc['find-process-mode'] || 'always'}",
        "global-client-fingerprint": "${doc['global-client-fingerprint'] || 'chrome'}",
        "external-controller": "${doc['external-controller'] || '0.0.0.0:9988'}",
        "secret": "${doc.secret || 'colinyycc'}",
        "profile": ${JSON.stringify(doc.profile, null, 4)},
        "sniffer": ${JSON.stringify(doc.sniffer, null, 4)}
    };
    Object.assign(params, config);
}

// DNS 配置轉換
function overwriteDns(params) {
    params.dns = ${JSON.stringify(doc.dns, null, 4)};
}

// TUN 配置轉換
function overwriteTunnel(params) {
    params.tun = ${JSON.stringify(doc.tun, null, 4)};
}

// 代理組配置轉換
function overwriteProxyGroups(params) {
    // 從 YAML 自動提取代理組結構
    const groups = ${JSON.stringify(doc['proxy-groups'], null, 4)};
    
    // 如果需要動態過濾節點，可以在此處針對 groups 進行 filter 處理
    params["proxy-groups"] = groups;
}

// Rule Providers 補全轉換
function overwriteRuleProviders(params) {
    // 自動獲取 YAML 中定義的所有 rule-providers
    const providers = ${JSON.stringify(doc['rule-providers'], null, 4)};
    params["rule-providers"] = providers;
}

// 分流規則轉換
function overwriteRules(params) {
    params.rules = ${JSON.stringify(doc.rules, null, 4)};
}
`;

    // 寫入檔案
    fs.writeFileSync(outputFile, jsContent, 'utf8');
    console.log('------------------------------------------');
    console.log('✅ 轉換成功！');
    console.log(`原文件: ${yamlFile}`);
    console.log(`生成文件: ${outputFile}`);
    console.log('------------------------------------------');

} catch (e) {
    console.error('❌ 轉換過程中發生錯誤：', e);
}
